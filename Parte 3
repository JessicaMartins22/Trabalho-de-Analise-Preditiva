# âœ… Instalar pacotes necessÃ¡rios
!pip install pandas numpy matplotlib statsmodels openpyxl --quiet

# âœ… ImportaÃ§Ã£o de bibliotecas
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from statsmodels.tsa.statespace.sarimax import SARIMAX
from statsmodels.tsa.seasonal import seasonal_decompose
import warnings
import locale
from google.colab import files

print("Insira os dados em excel:")

# âœ… ConfiguraÃ§Ã£o de ambiente
warnings.filterwarnings('ignore')

try:
    locale.setlocale(locale.LC_TIME, 'pt_BR.UTF-8')
except locale.Error:
    locale.setlocale(locale.LC_TIME, '')
    print("âš ï¸ Aviso: 'pt_BR.UTF-8' nÃ£o disponÃ­vel no Colab. Usando localidade padrÃ£o.")

# âœ… Upload do arquivo Excel
uploaded = files.upload()
arquivo = list(uploaded.keys())[0]

# âœ… Leitura e prÃ©-processamento dos dados
df = pd.read_excel(arquivo)
print("ğŸ“Œ Colunas encontradas no Excel:", df.columns.tolist())
df.columns = df.columns.str.strip().str.lower().str.replace(' ', '_')

if 'timestamp' not in df.columns:
    raise KeyError("âŒ A coluna 'timestamp' nÃ£o foi encontrada no Excel.")
df.rename(columns={'timestamp': 'data'}, inplace=True)

col_vendas = [col for col in df.columns if any(keyword in col for keyword in ['venda', 'vendas'])]
if not col_vendas:
    print("Colunas disponÃ­veis:", df.columns.tolist())
    coluna_sugerida = df.columns[1]
    print(f"SugestÃ£o: Renomear a coluna '{coluna_sugerida}' para 'vendas'")
    df.rename(columns={coluna_sugerida: 'vendas'}, inplace=True)
else:
    df.rename(columns={col_vendas[0]: 'vendas'}, inplace=True)

df['data'] = pd.to_datetime(df['data'])
df = df.sort_values('data').set_index('data')

df['ano'] = df.index.year
df['mes'] = df.index.month
df['semana'] = df.index.isocalendar().week

# âœ… DecomposiÃ§Ã£o da sÃ©rie temporal
%matplotlib inline
decomp = seasonal_decompose(df['vendas'], model='additive', period=30)
decomp.plot()
plt.suptitle('ğŸ” DecomposiÃ§Ã£o da SÃ©rie Temporal', fontsize=14)
plt.tight_layout()
plt.show()

# âœ… GrÃ¡fico de barras: Vendas totais por ano
vendas_anuais = df.groupby('ano')['vendas'].sum().reset_index()
vendas_anuais.plot(x='ano', y='vendas', kind='bar', figsize=(8,5), color='skyblue', legend=False)
plt.title('ğŸ“ˆ Vendas Totais por Ano')
plt.xlabel('Ano')
plt.ylabel('Total de Vendas')
plt.xticks(rotation=0)
plt.grid(axis='y')
plt.tight_layout()
plt.show()

# âœ… DistribuiÃ§Ã£o mensal de vendas (histÃ³rico)
vendas_mensal = df.groupby(['ano', 'mes'])['vendas'].sum().reset_index()
vendas_mensal['ano_mes'] = vendas_mensal['ano'].astype(str) + '-' + vendas_mensal['mes'].astype(str).str.zfill(2)
vendas_mensal.plot(x='ano_mes', y='vendas', kind='bar', figsize=(12,5), legend=False)
plt.title('ğŸ“… DistribuiÃ§Ã£o Mensal de Vendas')
plt.xlabel('Ano-MÃªs')
plt.ylabel('Vendas Totais')
plt.xticks(rotation=45)
plt.grid(axis='y')
plt.tight_layout()
plt.show()

# âœ… DistribuiÃ§Ã£o semanal de vendas (histÃ³rico)
vendas_semanal = df.groupby(['ano', 'semana'])['vendas'].sum().reset_index()
vendas_semanal['ano_semana'] = vendas_semanal['ano'].astype(str) + '-S' + vendas_semanal['semana'].astype(str).str.zfill(2)
vendas_semanal.plot(x='ano_semana', y='vendas', kind='bar', figsize=(14,5), legend=False)
plt.title('ğŸ“… DistribuiÃ§Ã£o Semanal de Vendas')
plt.xlabel('Ano-Semana')
plt.ylabel('Vendas Totais')
plt.xticks(rotation=90)
plt.grid(axis='y')
plt.tight_layout()
plt.show()

# âœ… Semana dentro do mÃªs
def semana_do_mes(dia):
    if dia <= 7:
        return 'Semana 1'
    elif dia <= 14:
        return 'Semana 2'
    elif dia <= 21:
        return 'Semana 3'
    else:
        return 'Semana 4'

df['semana_mes'] = df.index.day.map(semana_do_mes)

# âœ… Agrupamento por ano, mÃªs e semana do mÃªs
vendas_semana_mes = (
    df.groupby(['ano', 'mes', 'semana_mes'])['vendas']
    .sum()
    .reset_index()
    .sort_values(['ano', 'mes', 'semana_mes'])
)

# âœ… Criar coluna ano-mÃªs para o eixo
vendas_semana_mes['ano_mes'] = vendas_semana_mes['ano'].astype(str) + '-' + vendas_semana_mes['mes'].astype(str).str.zfill(2)

# âœ… Pivotar para ter cada semana como uma barra separada
pivot = vendas_semana_mes.pivot_table(index='ano_mes', columns='semana_mes', values='vendas', fill_value=0)

# âœ… Plotar grÃ¡fico
pivot.plot(kind='bar', figsize=(14,6))
plt.title('ğŸ“… DistribuiÃ§Ã£o Semanal Dentro do MÃªs')
plt.xlabel('Ano-MÃªs')
plt.ylabel('Vendas Totais')
plt.xticks(rotation=45)
plt.legend(title='Semana do MÃªs')
plt.grid(axis='y')
plt.tight_layout()
plt.show()

# âœ… Boxplot: DistribuiÃ§Ã£o mensal de vendas
plt.figure(figsize=(12,6))
df['ano_mes'] = df['ano'].astype(str) + '-' + df['mes'].astype(str).str.zfill(2)
df.boxplot(column='vendas', by='ano_mes', grid=False)
plt.title('ğŸ“¦ Boxplot de Vendas Mensais')
plt.suptitle('')
plt.xlabel('Ano-MÃªs')
plt.ylabel('Vendas')
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

# âœ… Nomear os meses
meses_nome = {
    1: 'Janeiro', 2: 'Fevereiro', 3: 'MarÃ§o', 4: 'Abril',
    5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
    9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
}
df['mes_nome'] = df['mes'].map(meses_nome)

# âœ… Boxplot: DistribuiÃ§Ã£o das vendas pelos 12 meses do ano (com nomes)
plt.figure(figsize=(12,6))
order_meses = list(meses_nome.values())
df.boxplot(column='vendas', by='mes_nome', grid=False)
plt.title('ğŸ“¦ Boxplot de Vendas por MÃªs do Ano')
plt.suptitle('')
plt.xlabel('MÃªs')
plt.ylabel('Vendas')
plt.xticks(ticks=np.arange(1,13), labels=order_meses, rotation=45)
plt.tight_layout()
plt.show()

# âœ… Boxplot: DistribuiÃ§Ã£o semanal geral de vendas
df['ano_semana'] = df['ano'].astype(str) + '-S' + df['semana'].astype(str).str.zfill(2)
plt.figure(figsize=(14,6))
df.boxplot(column='vendas', by='ano_semana', grid=False)
plt.title('ğŸ“¦ Boxplot de Vendas Semanais')
plt.suptitle('')
plt.xlabel('Ano-Semana')
plt.ylabel('Vendas')
plt.xticks(rotation=90)
plt.tight_layout()
plt.show()

# âœ… Boxplot: DistribuiÃ§Ã£o por semanas dentro do mÃªs
plt.figure(figsize=(10,6))
df.boxplot(column='vendas', by='semana_mes', grid=False)
plt.title('ğŸ“¦ Boxplot de Vendas por Semana do MÃªs')
plt.suptitle('')
plt.xlabel('Semana do MÃªs')
plt.ylabel('Vendas')
plt.tight_layout()
plt.show()

# âœ… Modelo SARIMA
# Move the SARIMA model fitting and prediction here so prev_df is defined before use.
modelo = SARIMAX(df['vendas'], order=(1,1,1), seasonal_order=(1,1,1,30))
resultado = modelo.fit()

# âœ… PrevisÃ£o para Dezembro/2024
inicio_prev = '2024-12-01'
fim_prev = '2024-12-31'
previsao = resultado.get_prediction(start=inicio_prev, end=fim_prev)
prev_df = previsao.summary_frame()[['mean']].rename(columns={'mean': 'vendas_previstas'})
prev_df['vendas_previstas'] = prev_df['vendas_previstas'].round(0)

prev_df['semana'] = prev_df.index.isocalendar().week
prev_df['dia'] = prev_df.index.day
prev_df['dia_da_semana'] = prev_df.index.strftime('%A')
prev_df['ano'] = prev_df.index.year

# âœ… MÃ©dias semanais histÃ³ricas
df_treino = df[df.index < '2024-12-01']
media_semanal_hist = (
    df_treino.groupby('semana')['vendas']
    .mean()
    .reset_index()
    .rename(columns={'vendas': 'media_historica_vendas'})
)

# âœ… Junta previsÃ£o com histÃ³rico semanal
prev_df = prev_df.merge(media_semanal_hist, on='semana', how='left')

# âœ… Exibe tabela final
print("\nğŸ“… PrevisÃ£o diÃ¡ria para Dezembro de 2024:")
print(prev_df[['dia', 'dia_da_semana', 'vendas_previstas', 'media_historica_vendas']])

# âœ… GrÃ¡fico comparativo por semana
# This section now comes AFTER prev_df is defined.
agrupado = prev_df.groupby('semana')[['vendas_previstas', 'media_historica_vendas']].mean()
agrupado.plot(kind='bar', figsize=(10,5))
plt.title('ğŸ“Š Comparativo Semanal: Dez/2024 vs MÃ©dia HistÃ³rica')
plt.xlabel('Semana do Ano')
plt.ylabel('Vendas MÃ©dias')
plt.grid(axis='y')
plt.tight_layout()
plt.show()

# âœ… CÃ¡lculo das mÃ©tricas de erro
prev_df['erro'] = prev_df['vendas_previstas'] - prev_df['media_historica_vendas']
prev_df['erro_absoluto'] = prev_df['erro'].abs()
prev_df['erro_quadrado'] = prev_df['erro'] ** 2

dm = prev_df['erro'].mean()
mad = prev_df['erro_absoluto'].mean()
mse = prev_df['erro_quadrado'].mean()
rmse = np.sqrt(mse)
made = mad

metricas_df = pd.DataFrame({
    'MÃ©trica': ['DM', 'MAD', 'MSE', 'RMSE', 'MADE'],
    'Valor': [dm, mad, mse, rmse, made]
})

print("\nğŸ“ MÃ©tricas de AvaliaÃ§Ã£o da PrevisÃ£o:")
print(metricas_df.to_string(index=False))

# âœ… PrevisÃ£o mÃ©todo naive para o Ãºltimo ano com dados completos
ultimo_ano = df.index.year.max()
dados_ultimo_ano = df[df.index.year == ultimo_ano]

# Ãšltimo valor real antes do ano analisado
ultimo_valor_treino = df[df.index.year < ultimo_ano]['vendas'].iloc[-1]

# SÃ©rie naive: repete o Ãºltimo valor conhecido para o ano inteiro
naive_pred = pd.Series(ultimo_valor_treino, index=dados_ultimo_ano.index)

# âœ… PrevisÃ£o mÃ©todo cumulativo (mÃ©dia dos dados anteriores)
media_cumulativa = df[df.index.year < ultimo_ano]['vendas'].mean()
cumulativa_pred = pd.Series(media_cumulativa, index=dados_ultimo_ano.index)

# âœ… PrevisÃ£o mÃ©todo de mÃ©dia mÃ³vel de 7 dias
media_movel_7 = df['vendas'].rolling(window=7).mean()
media_movel_7_pred = media_movel_7[df.index.year == ultimo_ano].dropna()

# âœ… PrevisÃ£o mÃ©todo de mÃ©dia mÃ³vel de 14 dias
media_movel_14 = df['vendas'].rolling(window=14).mean()
media_movel_14_pred = media_movel_14[df.index.year == ultimo_ano].dropna()

# âœ… PrevisÃ£o mÃ©todo de mÃ©dia mÃ³vel de 30 dias
media_movel_30 = df['vendas'].rolling(window=30).mean()
media_movel_30_pred = media_movel_30[df.index.year == ultimo_ano].dropna()

# âœ… PrevisÃ£o mÃ©todo de suavizaÃ§Ã£o exponencial simples com alpha = 0.4
alpha = 0.4
suavizacao_exponencial = df['vendas'].ewm(alpha=alpha, adjust=False).mean()
suavizacao_exponencial_pred = suavizacao_exponencial[df.index.year == ultimo_ano]

# âœ… GrÃ¡fico de linhas com as 6 previsÃµes e os valores reais
plt.figure(figsize=(14,7))
plt.plot(df.index[df.index.year == ultimo_ano], df['vendas'][df.index.year == ultimo_ano], label='Valores Reais', color='black', linewidth=2)
plt.plot(df.index[df.index.year == ultimo_ano], naive_pred, label='Naive', linestyle='--')
plt.plot(df.index[df.index.year == ultimo_ano], cumulativa_pred, label='Cumulativa', linestyle='--')
plt.plot(df.index[df.index.year == ultimo_ano], media_movel_7_pred, label='MÃ©dia MÃ³vel (7 dias)', linestyle='--')
plt.plot(df.index[df.index.year == ultimo_ano], media_movel_14_pred, label='MÃ©dia MÃ³vel (14 dias)', linestyle='--')
plt.plot(df.index[df.index.year == ultimo_ano], media_movel_30_pred, label='MÃ©dia MÃ³vel (30 dias)', linestyle='--')
plt.plot(df.index[df.index.year == ultimo_ano], suavizacao_exponencial_pred, label='SuavizaÃ§Ã£o Exponencial (alpha=0.4)', linestyle='--')

plt.title('ğŸ“Š ComparaÃ§Ã£o de PrevisÃµes e Valores Reais (Ano: {})'.format(ultimo_ano), fontsize=16)
plt.xlabel('Data')
plt.ylabel('Vendas')
plt.legend(loc='upper left')
plt.grid(True)
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

# âœ… CÃ¡lculo dos erros mÃ©dios absolutos (MAD) para cada mÃ©todo de previsÃ£o
erro_naive = np.abs(naive_pred - df['vendas'][df.index.year == ultimo_ano])
erro_cumulativa = np.abs(cumulativa_pred - df['vendas'][df.index.year == ultimo_ano])
# Ensure alignment for errors with moving averages and exponential smoothing
erro_media_movel_7 = np.abs(media_movel_7_pred - df['vendas'][media_movel_7_pred.index])
erro_media_movel_14 = np.abs(media_movel_14_pred - df['vendas'][media_movel_14_pred.index])
erro_media_movel_30 = np.abs(media_movel_30_pred - df['vendas'][media_movel_30_pred.index])
erro_suavizacao_exponencial = np.abs(suavizacao_exponencial_pred - df['vendas'][suavizacao_exponencial_pred.index])


# âœ… MAD de cada mÃ©todo
mad_naive = erro_naive.mean()
mad_cumulativa = erro_cumulativa.mean()
mad_media_movel_7 = erro_media_movel_7.mean()
mad_media_movel_14 = erro_media_movel_14.mean()
mad_media_movel_30 = erro_media_movel_30.mean()
mad_suavizacao_exponencial = erro_suavizacao_exponencial.mean()

# âœ… CriaÃ§Ã£o do DataFrame para exibir os resultados
metricas_mad = pd.DataFrame({
    'MÃ©todo': ['Naive', 'Cumulativa', 'MÃ©dia MÃ³vel (7 dias)', 'MÃ©dia MÃ³vel (14 dias)', 'MÃ©dia MÃ³vel (30 dias)', 'SuavizaÃ§Ã£o Exponencial'],
    'MAD': [mad_naive, mad_cumulativa, mad_media_movel_7, mad_media_movel_14, mad_media_movel_30, mad_suavizacao_exponencial]
})

# âœ… ExibiÃ§Ã£o das mÃ©tricas de erro
print("\nğŸ“ Erro MÃ©dio Absoluto (MAD) para cada mÃ©todo:")
print(metricas_mad.to_string(index=False))

# âœ… Identificar o mÃ©todo com menor MAD
melhor_metodo = metricas_mad.loc[metricas_mad['MAD'].idxmin()]
print(f"\nğŸ… O mÃ©todo com menor erro mÃ©dio absoluto (MAD) Ã©: {melhor_metodo['MÃ©todo']} com MAD = {melhor_metodo['MAD']:.2f}")

# âœ… GrÃ¡fico de linha para comparar as previsÃµes com os valores reais
plt.figure(figsize=(12, 6))

# Valores reais do Ãºltimo ano
plt.plot(df.loc[df.index.year == ultimo_ano].index, df['vendas'][df.index.year == ultimo_ano], label='Valores Reais', color='black', linewidth=2)

# PrevisÃµes dos diferentes mÃ©todos
plt.plot(df.loc[df.index.year == ultimo_ano].index, naive_pred, label='Naive', linestyle='--')
plt.plot(df.loc[df.index.year == ultimo_ano].index, cumulativa_pred, label='Cumulativa', linestyle='--')
# Ensure the index aligns when plotting moving averages and exponential smoothing
plt.plot(media_movel_7_pred.index, media_movel_7_pred, label='MÃ©dia MÃ³vel (7 dias)', linestyle='--')
plt.plot(media_movel_14_pred.index, media_movel_14_pred, label='MÃ©dia MÃ³vel (14 dias)', linestyle='--')
plt.plot(media_movel_30_pred.index, media_movel_30_pred, label='MÃ©dia MÃ³vel (30 dias)', linestyle='--')
plt.plot(suavizacao_exponencial_pred.index, suavizacao_exponencial_pred, label='SuavizaÃ§Ã£o Exponencial', linestyle='--')


# Destaque para o mÃ©todo com o menor MAD
# Map the best method name string to the actual prediction Series variable
prediction_series_map = {
    'Naive': naive_pred,
    'Cumulativa': cumulativa_pred,
    'MÃ©dia MÃ³vel (7 dias)': media_movel_7_pred,
    'MÃ©dia MÃ³vel (14 dias)': media_movel_14_pred,
    'MÃ©dia MÃ³vel (30 dias)': media_movel_30_pred,
    'SuavizaÃ§Ã£o Exponencial': suavizacao_exponencial_pred
}

melhor_metodo_pred_series = prediction_series_map[melhor_metodo['MÃ©todo']]

# Ensure the index aligns for the best method plot as well
plt.plot(melhor_metodo_pred_series.index, melhor_metodo_pred_series,
         label=f'{melhor_metodo["MÃ©todo"]} (Menor MAD)', linewidth=3, color='red')

# Ajustes finais no grÃ¡fico
plt.title('ğŸ“Š Comparativo das PrevisÃµes de Vendas com os Valores Reais')
plt.xlabel('Data')
plt.ylabel('Vendas')
plt.legend(loc='upper left')
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()


# Bibliotecas essenciais
import pandas as pd
from google.colab import files

# Envio do arquivo Excel pelo usuÃ¡rio
arquivo_enviado = files.upload()

# Leitura do Excel em um DataFrame
tabela = pd.read_excel(next(iter(arquivo_enviado)))

# PadronizaÃ§Ã£o das colunas
tabela.columns = ['Data', 'Vendas']
tabela['Data'] = pd.to_datetime(tabela['Data'], dayfirst=True)
tabela.set_index('Data', inplace=True)

# GeraÃ§Ã£o de variÃ¡veis defasadas (lags)
for atraso in range(1, 8):
    tabela[f'Lag_{atraso}'] = tabela['Vendas'].shift(atraso)

# EliminaÃ§Ã£o de registros com valores ausentes
tabela.dropna(inplace=True)

# ExibiÃ§Ã£o do resultado final
print("Base de dados pronta com 7 defasagens de vendas:")
display(tabela)
